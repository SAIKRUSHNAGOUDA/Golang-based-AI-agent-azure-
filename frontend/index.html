<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Azure Resource Map</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f8fafc;
    }

    #cy {
      width: 100%;
      height: 70%;
      border-bottom: 2px solid #ccc;
    }

    #chat-container {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #chat-box {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #question {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #ask-btn {
      padding: 10px 16px;
      background-color: #0078D7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #answer {
      background: #fff;
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      min-height: 40px;
      color: #333;
    }
  </style>

  <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
</head>
<body>

  <div id="cy"></div>

  <div id="chat-container">
    <div id="chat-box">
      <input id="question" type="text" placeholder="Ask your cloud assistant..." />
      <button id="ask-btn" onclick="askAI()">Ask</button>
    </div>
    <div id="answer">💬 AI responses will appear here.</div>
  </div>

  <script>
    async function fetchResources() {
      try {
        const res = await fetch('/api/resources');
        const data = await res.json();

        const elements = [];
        const nodesMap = new Map();

        data.forEach((res, i) => {
          const nodeId = 'n' + i;
          nodesMap.set(res.name, nodeId);
          elements.push({
            data: {
              id: nodeId,
              label: `${res.name}\n(${res.type.split('/').pop()})`,
              location: res.location,
            }
          });
        });

        for (let i = 1; i < elements.length; i++) {
          elements.push({
            data: {
              id: `e${i}`,
              source: elements[i - 1].data.id,
              target: elements[i].data.id,
            }
          });
        }

        cytoscape({
          container: document.getElementById('cy'),
          elements: elements,
          style: [
            {
              selector: 'node',
              style: {
                'background-color': '#0078D7',
                'label': 'data(label)',
                'color': '#fff',
                'text-valign': 'center',
                'text-halign': 'center',
                'font-size': '10px',
                'text-wrap': 'wrap',
                'text-max-width': '70px',
                'width': 60,
                'height': 60,
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#bbb',
                'target-arrow-color': '#bbb',
                'target-arrow-shape': 'triangle'
              }
            }
          ],
          layout: {
            name: 'cose',
            animate: true,
            padding: 50
          }
        });

      } catch (error) {
        document.getElementById('answer').innerText = "❌ Failed to load resource data.";
        console.error(error);
      }
    }

    async function askAI() {
      const question = document.getElementById('question').value;
      const answerBox = document.getElementById('answer');
      answerBox.innerText = "⏳ Thinking...";

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });

        if (!res.ok) {
          const text = await res.text();
          answerBox.innerText = `❌ Server error: ${text}`;
          return;
        }

        const data = await res.json();
        answerBox.innerText = data.answer || "❌ No response.";
      } catch (err) {
        answerBox.innerText = "❌ Could not connect to AI service.";
        console.error(err);
      }
    }

    fetchResources();
  </script>
</body>
</html>
